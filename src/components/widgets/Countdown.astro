---
import WidgetWrapper from '~/components/ui/WidgetWrapper.astro';
import Headline from '~/components/ui/Headline.astro';

export interface Props {
  title?: string;
  subtitle?: string;
  targetDate: string;
  showDays?: boolean;
  showHours?: boolean;
  showMinutes?: boolean;
  showSeconds?: boolean;
  id?: string;
  isDark?: boolean;
  bg?: string;
}

const {
  title,
  subtitle,
  targetDate,
  showDays = true,
  showHours = true,
  showMinutes = true,
  showSeconds = true,
  id,
  isDark = false,
  bg,
} = Astro.props;

const countdownId = `countdown-${Math.random().toString(36).substr(2, 9)}`;
---

<WidgetWrapper id={id} isDark={isDark} bg={bg} containerClass="max-w-3xl">
  {(title || subtitle) && <Headline title={title} subtitle={subtitle} classes={{ container: 'mb-8 text-center' }} />}
  <div id={countdownId} class="flex justify-center gap-4 md:gap-8" data-target={targetDate}>
    {
      showDays && (
        <div class="flex flex-col items-center">
          <div class="text-4xl md:text-6xl font-bold text-primary countdown-days">00</div>
          <div class="text-sm text-gray-500 dark:text-gray-400 uppercase tracking-wide">Days</div>
        </div>
      )
    }
    {
      showHours && (
        <div class="flex flex-col items-center">
          <div class="text-4xl md:text-6xl font-bold text-primary countdown-hours">00</div>
          <div class="text-sm text-gray-500 dark:text-gray-400 uppercase tracking-wide">Hours</div>
        </div>
      )
    }
    {
      showMinutes && (
        <div class="flex flex-col items-center">
          <div class="text-4xl md:text-6xl font-bold text-primary countdown-minutes">00</div>
          <div class="text-sm text-gray-500 dark:text-gray-400 uppercase tracking-wide">Minutes</div>
        </div>
      )
    }
    {
      showSeconds && (
        <div class="flex flex-col items-center">
          <div class="text-4xl md:text-6xl font-bold text-primary countdown-seconds">00</div>
          <div class="text-sm text-gray-500 dark:text-gray-400 uppercase tracking-wide">Seconds</div>
        </div>
      )
    }
  </div>
</WidgetWrapper>

<script define:vars={{ countdownId, targetDate }}>
  function initCountdown() {
    const container = document.getElementById(countdownId);
    if (!container) return;

    const target = new Date(targetDate).getTime();

    function update() {
      const now = new Date().getTime();
      const diff = target - now;

      if (diff <= 0) {
        container.innerHTML = '<p class="text-2xl font-bold text-primary">ðŸŽ‰ Event Started!</p>';
        return;
      }

      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((diff % (1000 * 60)) / 1000);

      const daysEl = container.querySelector('.countdown-days');
      const hoursEl = container.querySelector('.countdown-hours');
      const minutesEl = container.querySelector('.countdown-minutes');
      const secondsEl = container.querySelector('.countdown-seconds');

      if (daysEl) daysEl.textContent = String(days).padStart(2, '0');
      if (hoursEl) hoursEl.textContent = String(hours).padStart(2, '0');
      if (minutesEl) minutesEl.textContent = String(minutes).padStart(2, '0');
      if (secondsEl) secondsEl.textContent = String(seconds).padStart(2, '0');
    }

    update();
    setInterval(update, 1000);
  }

  initCountdown();
</script>
