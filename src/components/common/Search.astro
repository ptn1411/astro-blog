---
// Inspired by -> https://github.com/chrismwilliams/astro-theme-cactus/blob/main/src/components/Search.astro

import SearchIcon from '~/components/icons/SearchIcon.astro';
---

<site-search id="search" class="ms-auto">
  <button data-open-modal class="flex items-center justify-center rounded-md gap-1">
    <SearchIcon />
  </button>

  <dialog
    aria-label="search"
    class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-white dark:bg-[#0a0910ec] shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md opacity-0">
    <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
      <button
        data-close-modal
        class="ms-auto cursor-pointer rounded-full bg-black text-white px-4 py-2 dark:bg-white dark:text-black">
        Đóng ✕
      </button>

      {
        import.meta.env.DEV ? (
          <div class="mx-auto text-center dark:text-white">
            <p>
              Search is only available in production builds. <br />
              Try building and previewing the site to test it out locally.
            </p>
          </div>
        ) : (
          <div class="search-container dark:text-white">
            <div id="pagefind__search" />
          </div>
        )
      }
    </div>
  </dialog>
</site-search>

<script>
  let searchInitialized = false;

  const loadSearchLogic = async () => {
    if (searchInitialized) return;
    searchInitialized = true;

    try {
      const { initializeSearch } = await import('./searchLogic');
      initializeSearch();
    } catch (error) {
      console.error('Failed to load search logic:', error);
      searchInitialized = false; // Allow retry if failed
    }
  };

  const initSearchButton = () => {
    // If search is already initialized, the custom element's constructor
    // will handle the listeners for any new 'site-search' elements.
    if (searchInitialized) return;

    const searchElement = document.querySelector('site-search');
    const openBtn = searchElement?.querySelector<HTMLButtonElement>('button[data-open-modal]');

    if (openBtn) {
      openBtn.disabled = false;

      // Handle the initial click to lazy-load
      const handleFirstClick = async (event: MouseEvent) => {
        event.preventDefault();
        await loadSearchLogic();
        // After loading, the custom element's constructor will run for all 'site-search' elements
        // and attach the 'real' click listeners. We re-trigger click to open it now.
        if (searchInitialized) {
          openBtn.click();
        }
      };

      openBtn.addEventListener('click', handleFirstClick, { once: true });
    }
  };

  // Initial setup
  initSearchButton();

  // Setup keyboard shortcut (globally, only once)
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  if (!(window as any).searchShortcutAttached) {
    window.addEventListener('keydown', async (event: KeyboardEvent) => {
      if (event.key === '/') {
        const activeElement = document.activeElement;
        const isTyping =
          activeElement instanceof HTMLInputElement ||
          activeElement instanceof HTMLTextAreaElement ||
          (activeElement instanceof HTMLElement && activeElement.isContentEditable);

        if (!isTyping) {
          event.preventDefault();
          await loadSearchLogic();
          const openBtn = document.querySelector('site-search button[data-open-modal]') as HTMLButtonElement;
          if (openBtn) {
            openBtn.click();
          }
        }
      }
    });
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    (window as any).searchShortcutAttached = true;
  }

  // Support for View Transitions
  document.addEventListener('astro:page-load', () => {
    initSearchButton();
  });
</script>

<script is:inline>
  // Global flag for keyboard shortcut to avoid duplicates across page bundles
  window.searchShortcutAttached = window.searchShortcutAttached || false;
</script>

<style is:global>
  .dark {
    --pagefind-ui-primary: #eeeeee;
    --pagefind-ui-text: #eeeeee;
    --pagefind-ui-background: #152028;
    --pagefind-ui-border: #152028;
    --pagefind-ui-tag: #152028;
  }
</style>
