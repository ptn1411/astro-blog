---
const thresholdValue = Astro.props?.threshold ?? 200;
---

<button type="button" class="c-back-to-top" data-back-to-top data-threshold={thresholdValue} aria-label="Lên đầu trang">
  <span aria-hidden="true">↑</span>
</button>

<style is:inline>
  .c-back-to-top {
    position: fixed;
    right: 1.5rem;
    bottom: 2.5rem;
    z-index: 9999;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 2.75rem;
    height: 2.75rem;
    border-radius: 9999px;
    background-color: #0f172a;
    color: #ffffff;
    font-size: 1.35rem;
    border: none;
    box-shadow: 0 10px 25px rgba(15, 23, 42, 0.2);
    opacity: 0;
    pointer-events: none;
    transform: translateY(10px);
    transition:
      opacity 200ms ease,
      transform 200ms ease;
    cursor: pointer;
  }
  .c-back-to-top.is-visible {
    opacity: 1;
    pointer-events: auto;
    transform: translateY(0);
  }
  :global(.dark .c-back-to-top) {
    background-color: #e2e8f0;
    color: #0f172a;
  }
</style>

<script is:inline>
  const initBackToTop = () => {
    const btn = document.querySelector('[data-back-to-top]');
    if (!btn) return;

    const backToTopBtn = /** @type {HTMLElement & { __btScrollListener?: EventListener; __btClickListener?: EventListener; __btMenuObserver?: MutationObserver }} */ (btn);

    const threshold = Number(backToTopBtn.dataset.threshold ?? 200);
    const headerMenu = document.querySelector('[data-toggle-menu]');

    const existingScrollListener = /** @type {EventListener | undefined} */ (backToTopBtn.__btScrollListener);
    const existingClickListener = /** @type {EventListener | undefined} */ (backToTopBtn.__btClickListener);
    const existingObserver = backToTopBtn.__btMenuObserver;

    if (existingScrollListener) {
      window.removeEventListener('scroll', existingScrollListener);
    }
    if (existingClickListener) {
      backToTopBtn.removeEventListener('click', existingClickListener);
    }
    if (existingObserver) {
      existingObserver.disconnect();
    }

    const toggle = () => {
      const menuExpanded = headerMenu instanceof HTMLElement && headerMenu.getAttribute('aria-expanded') === 'true';
      const scrollTop = window.scrollY || document.documentElement.scrollTop || document.body.scrollTop || 0;
      const shouldShow = scrollTop > threshold && !menuExpanded;
      backToTopBtn.classList.toggle('is-visible', shouldShow);
    };

    const handleScroll = () => toggle();
    const handleClick = () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    window.addEventListener('scroll', handleScroll, { passive: true });
    backToTopBtn.addEventListener('click', handleClick);

    backToTopBtn.__btScrollListener = handleScroll;
    backToTopBtn.__btClickListener = handleClick;

    toggle();

    if (headerMenu) {
      const observer = new MutationObserver(toggle);
      observer.observe(headerMenu, { attributes: true, attributeFilter: ['aria-expanded'] });
      backToTopBtn.__btMenuObserver = observer;
    }
  };

  const runWhenReady = () => {
    requestAnimationFrame(() => {
      requestAnimationFrame(initBackToTop);
    });
  };

  if (document.readyState === 'loading') {
    window.addEventListener('DOMContentLoaded', runWhenReady, { once: true });
  } else {
    runWhenReady();
  }

  document.addEventListener('astro:after-swap', runWhenReady);
  document.addEventListener('astro:page-load', runWhenReady);
</script>
