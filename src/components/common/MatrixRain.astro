---
/**
 * Matrix Rain Effect (Astro native version)
 * Ported from React to Astro with pure JS and Canvas API
 */
---

<canvas
  id="matrix-rain"
  class="matrix-rain hidden fixed inset-0 w-full h-full z-[5]"
  aria-label="Matrix Rain background"></canvas>

<style>
  .matrix-rain.hidden {
    display: none;
  }
  .matrix-rain.visible {
    display: block;
  }
</style>

<script is:inline>
  const startMatrixRain = () => {
    const canvas = document.getElementById('matrix-rain');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    let width = window.innerWidth;
    let height = window.innerHeight;
    canvas.width = width;
    canvas.height = height;

    const japaneseChars = [
      'ã‚¢',
      'ã‚¤',
      'ã‚¦',
      'ã‚¨',
      'ã‚ª',
      'ã‚«',
      'ã‚­',
      'ã‚¯',
      'ã‚±',
      'ã‚³',
      'ã‚µ',
      'ã‚·',
      'ã‚¹',
      'ã‚»',
      'ã‚½',
      'ã‚¿',
      'ãƒ',
      'ãƒ„',
      'ãƒ†',
      'ãƒˆ',
      'ãƒŠ',
      'ãƒ‹',
      'ãƒŒ',
      'ãƒ',
      'ãƒŽ',
      'ãƒ',
      'ãƒ’',
      'ãƒ•',
      'ãƒ˜',
      'ãƒ›',
      'ãƒž',
      'ãƒŸ',
      'ãƒ ',
      'ãƒ¡',
      'ãƒ¢',
      'ãƒ¤',
      'ãƒ¦',
      'ãƒ¨',
      'ãƒ©',
      'ãƒª',
      'ãƒ«',
      'ãƒ¬',
      'ãƒ­',
      'ãƒ¯',
      'ãƒ²',
      'ãƒ³',
      'ã‚',
      'ã„',
      'ã†',
      'ãˆ',
      'ãŠ',
      'ã‹',
      'ã',
      'ã',
      'ã‘',
      'ã“',
      'ã•',
      'ã—',
      'ã™',
      'ã›',
      'ã',
      'ãŸ',
      'ã¡',
      'ã¤',
      'ã¦',
      'ã¨',
      'ãª',
      'ã«',
      'ã¬',
      'ã­',
      'ã®',
      'ã¯',
      'ã²',
      'ãµ',
      'ã¸',
      'ã»',
      'ã¾',
      'ã¿',
      'ã‚€',
      'ã‚',
      'ã‚‚',
      'ã‚„',
      'ã‚†',
      'ã‚ˆ',
      'ã‚‰',
      'ã‚Š',
      'ã‚‹',
      'ã‚Œ',
      'ã‚',
      'ã‚',
      'ã‚’',
      'ã‚“',
      'æ—¥',
      'æœˆ',
      'ç«',
      'æ°´',
      'æœ¨',
      'é‡‘',
      'åœŸ',
      'å±±',
      'å·',
      'æµ·',
      'ç©º',
      'é›¨',
      'é›ª',
      'é¢¨',
      'é›²',
      'æ˜Ÿ',
      'å…‰',
      'å½±',
      'æ™‚',
      'é–“',
    ];

    class Drop {
      constructor() {
        this.x = Math.random() * width;
        this.y = Math.random() * -height;
        this.speed = Math.random() * 0.8 + 0.3;
        this.characters = Array.from(
          { length: Math.floor(Math.random() * 15) + 5 },
          () => japaneseChars[Math.floor(Math.random() * japaneseChars.length)]
        );
        this.updateFrequency = Math.floor(Math.random() * 10) + 5;
        this.lastUpdate = 0;
      }
    }

    let drops = Array.from({ length: Math.floor(width / 25) }, () => new Drop());
    const mouse = { x: 0, y: 0 };
    window.addEventListener('mousemove', (e) => {
      mouse.x = e.clientX;
      mouse.y = e.clientY;
    });

    window.addEventListener('resize', () => {
      width = window.innerWidth;
      height = window.innerHeight;
      canvas.width = width;
      canvas.height = height;
      drops = Array.from({ length: Math.floor(width / 25) }, () => new Drop());
    });

    const influenceRadius = 180;
    const draw = () => {
      ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
      ctx.fillRect(0, 0, width, height);

      drops.forEach((drop, i) => {
        const dx = mouse.x - drop.x;
        const dy = mouse.y - drop.y;
        const distance = Math.sqrt(dx * dx + dy * dy);
        drop.characters.forEach((char, j) => {
          const y = drop.y - j * 24;
          if (y < height && y > 0) {
            if (distance < influenceRadius) {
              const intensity = 1 - distance / influenceRadius;
              const r = Math.floor(120 * intensity);
              const g = Math.floor(220 * intensity);
              const b = Math.floor(255 * intensity);
              ctx.fillStyle = `rgb(${r},${g},${b})`;
            } else {
              const opacity = j === 0 ? 1 : 1 - j / drop.characters.length;
              ctx.fillStyle = `rgba(180,180,180,${opacity})`;
            }
            ctx.font = '18px "Hiragino Sans", "MS Gothic", monospace';
            ctx.fillText(char, drop.x, y);
          }
        });
        drop.y += drop.speed;
        drop.lastUpdate++;
        if (drop.lastUpdate > drop.updateFrequency) {
          drop.lastUpdate = 0;
          drop.characters[0] = japaneseChars[Math.floor(Math.random() * japaneseChars.length)];
        }
        if (drop.y - drop.characters.length * 24 > height) drops[i] = new Drop();
      });
      requestAnimationFrame(draw);
    };
    draw();
  };

  // ðŸ§  Run once on initial load
  document.addEventListener('DOMContentLoaded', startMatrixRain);

  // ðŸ” Run again after Astro navigation swaps
  document.addEventListener('astro:after-swap', () => {
    // Re-init canvas after page navigation
    startMatrixRain();
  });
</script>
