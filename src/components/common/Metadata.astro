---
import merge from 'lodash.merge';
import { AstroSeo } from '@astrolib/seo';

import type { Props as AstroSeoProps } from '@astrolib/seo';

import { SITE, METADATA, I18N } from 'astrowind:config';
import type { MetaData } from '~/types';
import { getCanonical } from '~/utils/permalinks';

import { adaptOpenGraphImages } from '~/utils/images';

export interface Props extends MetaData {
  dontUseTitleTemplate?: boolean;
}

const {
  title,
  ignoreTitleTemplate = false,
  canonical = String(getCanonical(String(Astro.url.pathname))),
  robots = {},
  description,
  openGraph = {},
  twitter = {},
  structuredData: structuredDataProp,
} = Astro.props;

const seoProps: AstroSeoProps = merge(
  {
    title: '',
    titleTemplate: '%s',
    canonical: canonical,
    noindex: true,
    nofollow: true,
    description: undefined,
    openGraph: {
      url: canonical,
      site_name: SITE?.name,
      images: [],
      locale: I18N?.language || 'en',
      type: 'website',
    },
    twitter: {
      cardType: openGraph?.images?.length ? 'summary_large_image' : 'summary',
    },
  },
  {
    title: METADATA?.title?.default,
    titleTemplate: METADATA?.title?.template,
    noindex: typeof METADATA?.robots?.index !== 'undefined' ? !METADATA.robots.index : undefined,
    nofollow: typeof METADATA?.robots?.follow !== 'undefined' ? !METADATA.robots.follow : undefined,
    description: METADATA?.description,
    openGraph: METADATA?.openGraph,
    twitter: METADATA?.twitter,
  },
  {
    title: title,
    titleTemplate: ignoreTitleTemplate ? '%s' : undefined,
    canonical: canonical,
    noindex: typeof robots?.index !== 'undefined' ? !robots.index : undefined,
    nofollow: typeof robots?.follow !== 'undefined' ? !robots.follow : undefined,
    description: description,
    openGraph: { url: canonical, ...openGraph },
    twitter: twitter,
  }
);

const adaptedOpenGraph = await adaptOpenGraphImages(seoProps?.openGraph, Astro.site);
const finalSeoProps = {
  ...seoProps,
  openGraph: adaptedOpenGraph,
} as AstroSeoProps;

const canonicalUrl = finalSeoProps.canonical || canonical;
const siteUrl = SITE?.site || (Astro.site ? String(Astro.site) : undefined);
const language = I18N?.language || 'en';

const structuredNodes: Array<Record<string, unknown>> = [];

if (siteUrl) {
  const trimmedSiteUrl = siteUrl.replace(/\/+$/, '');
  structuredNodes.push({
    '@context': 'https://schema.org',
    '@type': 'WebSite',
    name: SITE?.name || finalSeoProps.title || METADATA?.title?.default,
    url: trimmedSiteUrl || siteUrl,
    inLanguage: language,
  });
}

if (canonicalUrl) {
  const pageNode: Record<string, unknown> = {
    '@context': 'https://schema.org',
    '@type': 'WebPage',
    name: finalSeoProps.title || METADATA?.title?.default || SITE?.name,
    url: canonicalUrl,
    description: finalSeoProps.description || METADATA?.description,
    inLanguage: language,
  };

  const ogImages = finalSeoProps.openGraph?.images?.map((image) => image?.url).filter(Boolean) as string[] | undefined;
  if (ogImages?.length) {
    pageNode.image = ogImages;
  }

  structuredNodes.push(pageNode);
}

const extraStructuredData = Array.isArray(structuredDataProp)
  ? structuredDataProp
  : structuredDataProp
    ? [structuredDataProp]
    : [];

extraStructuredData.forEach((node) => {
  if (node && typeof node === 'object') {
    structuredNodes.push(node['@context'] ? node : { '@context': 'https://schema.org', ...node });
  }
});

const structuredDataJson =
  structuredNodes.length > 0
    ? JSON.stringify(structuredNodes.length === 1 ? structuredNodes[0] : structuredNodes, null, 2)
    : undefined;
---

<AstroSeo {...finalSeoProps} />
{structuredDataJson && <script type="application/ld+json" set:html={structuredDataJson} />}
