---

---

<script>
  // Added check to prevent script execution if not in browser
  if (typeof document === 'undefined') return;

  import { playAnimeAnimation, playGSAPAnimation, playLoopAnimation } from '~/components/admin/story/animations';

  const initAnimations = () => {
    console.log('[Animations] Checking for elements...');
    const animatedElements = document.querySelectorAll<HTMLElement>(
      '[data-animation-engine="gsap"], [data-animation-engine="anime"]'
    );

    if (animatedElements.length === 0) {
      console.log('[Animations] No animated elements found.');
      return;
    }

    console.log(`[Animations] Found ${animatedElements.length} elements.`);

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const el = entry.target as HTMLElement;
            if (el.dataset.animated === 'true') return;
            el.dataset.animated = 'true';

            const engine = el.dataset.animationEngine;
            const type = el.dataset.animationType;
            const duration = Number(el.dataset.animationDuration || 1000);
            const delay = Number(el.dataset.animationDelay || 0);
            const loop = el.dataset.loopAnimation;

            console.log(`[Animations] Triggering: ${type} (${engine}) for el:`, el);

            if (type) {
              if (engine === 'gsap') {
                playGSAPAnimation(el, type, { duration: duration / 1000, delay: delay / 1000 });
              } else if (engine === 'anime') {
                playAnimeAnimation(el, type, { duration, delay });
              }
            }

            if (loop && (engine === 'gsap' || engine === 'anime')) {
              setTimeout(() => playLoopAnimation(el, loop, engine), duration + delay);
            }

            observer.unobserve(el);
          }
        });
      },
      {
        threshold: 0.1,
        rootMargin: '50px', // Start slightly before it enters view
      }
    );

    animatedElements.forEach((el) => {
      // Reset state for re-animation if needed (useful for view transitions)
      el.removeAttribute('data-animated');
      observer.observe(el);
    });
  };

  // Run on every view transition
  document.addEventListener('astro:page-load', initAnimations);
  document.addEventListener('astro:after-swap', initAnimations);
</script>
