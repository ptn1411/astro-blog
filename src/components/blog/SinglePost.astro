---
import { Icon } from 'astro-icon/components';
import PostTags from '~/components/blog/Tags.astro';
import Image from '~/components/common/Image.astro';
import SocialShare from '~/components/common/SocialShare.astro';
import TableOfContents from '~/components/widgets/TableOfContents.astro';
import { getPermalink } from '~/utils/permalinks';
import { getFormattedDate } from '~/utils/utils';
import type { Post } from '~/types';

export interface Props {
  post: Post;
  url: string | URL;
}

const { post, url } = Astro.props;
const headings = post.headings;
---

<section class="py-10 sm:py-16 lg:py-20 mx-auto max-w-6xl px-4 sm:px-6 lg:px-8">
  <article class="w-full">
    <!-- Header -->
    <header
      class="text-center intersect-once intersect-quarter motion-safe:md:opacity-0 motion-safe:md:intersect:animate-fade">
      <div class="flex flex-wrap justify-center items-center text-sm text-gray-500 dark:text-gray-400 mb-3 gap-x-2">
        <Icon name="tabler:clock" class="w-4 h-4 inline-block -mt-0.5" />
        <time datetime={String(post.publishDate)}>{getFormattedDate(post.publishDate)}</time>

        {
          post.author && (
            <>
              · <Icon name="tabler:user" class="w-4 h-4 inline-block -mt-0.5" />
              <span>{post.author}</span>
            </>
          )
        }

        {
          post.category && (
            <>
              ·{' '}
              <a
                class="hover:underline text-primary dark:text-blue-400"
                href={getPermalink(post.category.slug, 'category')}>
                {post.category.title}
              </a>
            </>
          )
        }

        {post.readingTime && <> · {post.readingTime} phút đọc</>}
      </div>

      <h1 class="text-4xl md:text-5xl font-bold font-heading leading-tight tracking-tight mt-2 mb-4 max-w-3xl mx-auto">
        {post.title}
      </h1>

      {
        post.excerpt && (
          <p class="text-lg md:text-xl text-muted dark:text-slate-400 max-w-3xl mx-auto text-center mb-8">
            {post.excerpt}
          </p>
        )
      }

      {
        post.image ? (
          <Image
            src={post.image}
            class="max-w-4xl mx-auto mb-8 rounded-lg shadow-md bg-gray-300 dark:bg-slate-700"
            widths={[400, 900]}
            sizes="(max-width: 900px) 400px, 900px"
            alt={post.excerpt || post.title}
            width={900}
            height={506}
            loading="eager"
            decoding="async"
          />
        ) : (
          <div class="border-t border-gray-200 dark:border-slate-700 max-w-3xl mx-auto my-8" />
        )
      }
    </header>
    <hr class="border-t border-gray-200 dark:border-slate-700" />
    <!-- Layout -->
    <div
      class:list={[
        'grid gap-10 lg:gap-14',
        headings && headings.length > 0 ? 'md:grid-cols-[280px_minmax(0,1fr)]' : 'grid-cols-1 justify-items-center',
      ]}>
      {
        headings && headings.length > 0 && (
          <aside class="hidden md:block">
            <div class="sticky top-28 self-start space-y-4">
              <TableOfContents {headings} />
            </div>
          </aside>
        )
      }

      <!-- Article -->
      <article
        class:list={['w-full', headings && headings.length > 0 ? 'max-w-prose' : 'max-w-3xl mx-auto text-center']}>
        <div
          class="prose dark:prose-invert prose-img:rounded-md prose-img:shadow-lg prose-headings:scroll-mt-[90px] prose-headings:font-heading prose-headings:font-semibold prose-a:text-primary dark:prose-a:text-blue-400 prose-p:text-justify">
          <slot />
        </div>

        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mt-10 gap-4">
          <PostTags tags={post.tags} />
          <SocialShare url={url} text={post.title} class="text-gray-500 dark:text-slate-500" />
        </div>
      </article>
    </div>
  </article>
</section>

<!-- Intersection Observer: Highlight current TOC item -->
<script is:inline>
  const initTOCHighlight = () => {
    if (window.__tocObserver__) window.__tocObserver__.disconnect();

    const headings = document.querySelectorAll(
      'div.prose h1, div.prose h2, div.prose h3, div.prose h4, div.prose h5, div.prose h6'
    );
    const tocLinks = document.querySelectorAll('aside a[href^="#"]');
    if (!headings.length || !tocLinks.length) return;

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          const targetId = entry.target.id;
          const activeLink = document.querySelector(`aside a[href="#${targetId}"]`);
          if (entry.isIntersecting && activeLink) {
            tocLinks.forEach((link) =>
              link.classList.remove('bg-teal-600', 'dark:bg-teal-700', 'text-white', 'scale-[1.05]', 'shadow-md')
            );
            activeLink.classList.add(
              'bg-teal-600',
              'dark:bg-teal-700',
              'text-white',
              'transition-all',
              'duration-300',
              'scale-[1.05]',
              'shadow-md',
              'rounded-md'
            );
            activeLink.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
          }
        });
      },
      { root: null, rootMargin: '0px 0px -70% 0px', threshold: 0 }
    );

    headings.forEach((h) => observer.observe(h));
    window.__tocObserver__ = observer;
  };

  document.addEventListener('DOMContentLoaded', initTOCHighlight);
  document.addEventListener('astro:after-swap', initTOCHighlight);
</script>
