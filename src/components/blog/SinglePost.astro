---
import { getCollection } from 'astro:content';
import { Icon } from 'astro-icon/components';
import PostTags from '~/components/blog/Tags.astro';
import Image from '~/components/common/Image.astro';
import SocialShare from '~/components/common/SocialShare.astro';
import TableOfContents from '~/components/widgets/TableOfContents.astro';
import { cleanSlug, getAuthorPermalink, getPermalink } from '~/utils/permalinks';
import { getFormattedDate } from '~/utils/utils';
import type { Post } from '~/types';
import { findSeriesPosts } from '~/utils/blog';

export interface Props {
  post: Post;
  url: string | URL;
}

const { post, url } = Astro.props;
const headings = post.headings;
const authorEntries = await getCollection('author');
const authorSlugMap = new Map(authorEntries.map((entry) => [entry.data.name, cleanSlug(entry.data.username)]));
const authorSlug = post.author ? (authorSlugMap.get(post.author) ?? cleanSlug(post.author)) : undefined;
const seriesPosts = post.series ? await findSeriesPosts(post) : [];
const currentSeriesIndex = seriesPosts.findIndex((p) => p.slug === post.slug);
const previousSeriesPost = currentSeriesIndex > 0 ? seriesPosts[currentSeriesIndex - 1] : undefined;
const nextSeriesPost =
  currentSeriesIndex >= 0 && currentSeriesIndex < seriesPosts.length - 1
    ? seriesPosts[currentSeriesIndex + 1]
    : undefined;
---

<section class="py-10 sm:py-16 lg:py-20 mx-auto max-w-6xl px-4 sm:px-6 lg:px-8">
  <article class="w-full">
    <!-- Header -->
    <header
      class="text-center intersect-once intersect-quarter motion-safe:md:opacity-0 motion-safe:md:intersect:animate-fade">
      <div class="flex flex-wrap justify-center items-center text-sm text-gray-500 dark:text-gray-400 mb-3 gap-x-2">
        <Icon name="tabler:clock" class="w-4 h-4 inline-block -mt-0.5" />
        <time datetime={String(post.publishDate)}>{getFormattedDate(post.publishDate)}</time>

        {
          post.author && (
            <>
              {' '}
              · <Icon name="tabler:user" class="w-3.5 h-3.5 inline-block -mt-0.5 dark:text-gray-400" />
              {authorSlug ? (
                <a class="hover:underline text-primary dark:text-blue-400" href={getAuthorPermalink(authorSlug)}>
                  {post.author.replaceAll('-', ' ')}
                </a>
              ) : (
                <span>{post.author.replaceAll('-', ' ')}</span>
              )}
            </>
          )
        }

        {
          post.category && (
            <>
              ·{' '}
              <a
                class="hover:underline text-primary dark:text-blue-400"
                href={getPermalink(post.category.slug, 'category')}>
                {post.category.title}
              </a>
            </>
          )
        }

        {post.readingTime && <> · {post.readingTime} phút đọc</>}
      </div>

      <h1 class="text-4xl md:text-5xl font-bold font-heading leading-tight tracking-tight mt-2 mb-4 max-w-3xl mx-auto">
        {post.title}
      </h1>

      {
        post.excerpt && (
          <p class="text-lg md:text-xl text-muted dark:text-slate-400 max-w-3xl mx-auto text-center mb-8">
            {post.excerpt}
          </p>
        )
      }

      {
        post.image ? (
          <Image
            src={post.image}
            class="max-w-4xl mx-auto mb-8 rounded-lg shadow-md bg-gray-300 dark:bg-slate-700"
            widths={[400, 900]}
            sizes="(max-width: 900px) 400px, 900px"
            alt={post.excerpt || post.title}
            width={900}
            height={506}
            loading="eager"
            decoding="async"
          />
        ) : (
          <div class="border-t border-gray-200 dark:border-slate-700 max-w-3xl mx-auto my-8" />
        )
      }
    </header>

    <!-- Layout -->
    <div
      class:list={[
        'grid gap-10 lg:gap-14',
        headings && headings.length > 0 ? 'md:grid-cols-[280px_minmax(0,1fr)]' : 'grid-cols-1 justify-items-center',
      ]}>
      {
        headings && headings.length > 0 && (
          <aside class="hidden md:block">
            <div class="sticky top-28 self-start space-y-4">
              <TableOfContents {headings} />
            </div>
          </aside>
        )
      }

      <!-- Article -->
      <article
        class:list={['w-full', headings && headings.length > 0 ? 'max-w-prose' : 'max-w-3xl mx-auto text-center']}>
        <div
          class="prose dark:prose-invert prose-img:rounded-md prose-img:shadow-lg prose-headings:scroll-mt-[90px] prose-headings:font-heading prose-headings:font-semibold prose-a:text-primary dark:prose-a:text-blue-400 prose-p:text-justify">
          <slot />
        </div>

        {
          post.series && seriesPosts.length > 0 && (
            <section class="mt-12 p-6 rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/80 dark:bg-slate-900/60 shadow-sm">
              <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                <div>
                  <p class="text-sm uppercase tracking-widest text-muted dark:text-slate-400">Chuỗi bài viết</p>
                  <h2 class="text-2xl font-semibold text-slate-900 dark:text-white">
                    {post.series.title ?? 'Series liên quan'}
                  </h2>
                  {post.series.part && (
                    <p class="text-sm text-gray-600 dark:text-slate-400">
                      Phần {post.series.part}
                      {post.series.totalParts ? ` / ${post.series.totalParts}` : ''}
                    </p>
                  )}
                </div>
                <div class="text-sm font-medium text-primary dark:text-blue-400">{seriesPosts.length} bài viết</div>
              </div>

              <ol class="mt-6 space-y-3">
                {seriesPosts.map((seriesPost, index) => {
                  const isActive = seriesPost.slug === post.slug;
                  return (
                    <li
                      class:list="flex items-start gap-4 rounded-xl border px-4 py-3 transition hover:border-primary/60 dark:hover:border-blue-400/60"
                      class={
                        (isActive
                          ? 'border-primary/60 dark:border-blue-400/80 bg-primary/5 dark:bg-blue-400/10'
                          : 'border-slate-200 dark:border-slate-700') as string
                      }>
                      <span class="text-sm font-semibold text-slate-500 dark:text-slate-300 shrink-0 pt-1">
                        Phần {seriesPost.series?.part ?? index + 1}
                      </span>
                      <a
                        href={getPermalink(seriesPost.permalink, 'post')}
                        class:list={[
                          'flex-1 text-left',
                          isActive
                            ? 'text-primary dark:text-blue-300 font-semibold'
                            : 'text-slate-900 dark:text-white hover:text-primary dark:hover:text-blue-300',
                        ]}>
                        {seriesPost.title}
                      </a>
                    </li>
                  );
                })}
              </ol>

              <div class="mt-6 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                {previousSeriesPost ? (
                  <a
                    class="inline-flex items-center gap-2 text-sm text-primary dark:text-blue-400 hover:underline"
                    href={getPermalink(previousSeriesPost.permalink, 'post')}>
                    ← Phần trước: {previousSeriesPost.title}
                  </a>
                ) : (
                  <span class="text-sm text-slate-400">Đang ở phần đầu tiên</span>
                )}
                {nextSeriesPost ? (
                  <a
                    class="inline-flex items-center gap-2 text-sm text-primary dark:text-blue-400 hover:underline"
                    href={getPermalink(nextSeriesPost.permalink, 'post')}>
                    Phần tiếp theo: {nextSeriesPost.title} →
                  </a>
                ) : (
                  <span class="text-sm text-slate-400 text-right">Đã đến phần cuối cùng</span>
                )}
              </div>
            </section>
          )
        }

        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mt-10 gap-4">
          <PostTags tags={post.tags} />
          <SocialShare url={url} text={post.title} class="text-gray-500 dark:text-slate-500" />
        </div>
        <section id="comments" class="mt-12 w-full">
          <h2 class="text-xl font-semibold mb-4 text-left">Bình luận</h2>
          <script
            src="https://giscus.app/client.js"
            data-repo="ptn1411/astro-blog"
            data-repo-id="R_kgDOQM1cMA"
            data-category="Announcements"
            data-category-id="DIC_kwDOQM1cMM4Cxkzs"
            data-mapping="pathname"
            data-strict="0"
            data-reactions-enabled="1"
            data-emit-metadata="0"
            data-input-position="bottom"
            data-lang="vi"
            data-theme="light"
            crossorigin="anonymous"
            async></script>
        </section>
      </article>
    </div>
  </article>
</section>

<!-- Intersection Observer: Highlight current TOC item -->
<script is:inline>
  const initTOCHighlight = () => {
    if (window.__tocObserver__) window.__tocObserver__.disconnect();

    const headings = document.querySelectorAll(
      'div.prose h1, div.prose h2, div.prose h3, div.prose h4, div.prose h5, div.prose h6'
    );
    const tocLinks = document.querySelectorAll('aside a[href^="#"]');
    if (!headings.length || !tocLinks.length) return;

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          const targetId = entry.target.id;
          const activeLink = document.querySelector(`aside a[href="#${targetId}"]`);
          if (entry.isIntersecting && activeLink) {
            tocLinks.forEach((link) =>
              link.classList.remove('bg-teal-600', 'dark:bg-teal-700', 'text-white', 'scale-[1.05]', 'shadow-md')
            );
            activeLink.classList.add(
              'bg-teal-600',
              'dark:bg-teal-700',
              'text-white',
              'transition-all',
              'duration-300',
              'scale-[1.05]',
              'shadow-md',
              'rounded-md'
            );
            activeLink.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
          }
        });
      },
      { root: null, rootMargin: '0px 0px -70% 0px', threshold: 0 }
    );

    headings.forEach((h) => observer.observe(h));
    window.__tocObserver__ = observer;
  };
  const mountGiscus = () => {
    const container = document.querySelector('#comments');
    if (!container) return;

    container.querySelector('iframe.giscus-frame')?.remove();
    container.querySelector('script[data-giscus]')?.remove();

    const script = document.createElement('script');
    script.src = 'https://giscus.app/client.js';
    script.setAttribute('data-giscus', 'true');
    script.dataset.repo = 'ptn1411/astro-blog';

    script.dataset.repoId = 'R_kgDOQM1cMA';
    script.dataset.category = 'Announcements';
    script.dataset.categoryId = 'DIC_kwDOQM1cMM4Cxkzs';
    script.dataset.mapping = 'pathname';
    script.dataset.strict = '0';
    script.dataset.reactionsEnabled = '1';
    script.dataset.emitMetadata = '0';
    script.dataset.inputPosition = 'bottom';
    script.dataset.lang = 'vi';

    script.dataset.theme = getCurrentTheme();
    script.crossOrigin = 'anonymous';
    script.async = true;
    container.appendChild(script);
  };
  const getCurrentTheme = () => (document.documentElement.classList.contains('dark') ? 'dark' : 'light');

  const syncGiscusTheme = () => {
    const iframe = document.querySelector('iframe.giscus-frame');
    if (!iframe) return;
    iframe.contentWindow?.postMessage({ giscus: { setConfig: { theme: getCurrentTheme() } } }, 'https://giscus.app');
  };

  const initGiscusTheme = () => {
    const script = document.querySelector('#comments script[data-repo]');
    if (script) script.setAttribute('data-theme', getCurrentTheme());
    setTimeout(syncGiscusTheme, 500); // đợi iframe load
  };

  document.addEventListener('DOMContentLoaded', () => {
    initTOCHighlight();
    mountGiscus();
    initGiscusTheme();
  });
  document.addEventListener('astro:after-swap', () => {
    initTOCHighlight();
    mountGiscus();
    initGiscusTheme();
  });
  window.addEventListener('aw:theme-change', syncGiscusTheme);
</script>
