---
import BlogList from '~/components/blog/List.astro';
import BackToTop from '~/components/common/BackToTop.astro';
import Layout from '~/layouts/PageLayout.astro';

import type { ImageMetadata } from 'astro';
import type { AstroComponentFactory } from 'astro/runtime/server/index.js';
import type { CollectionEntry } from 'astro:content';
import type { MetaData, Post } from '~/types';
import { cleanSlug } from '~/utils/permalinks';

export interface Props {
  metadata?: MetaData;
  author: {
    name: string;
    username?: string;
    bio?: string;
    website?: string;
    avatar?: ImageMetadata | string;
  };
  posts: Array<Post>;
  stories?: Array<CollectionEntry<'stories'>>;
  Content?: AstroComponentFactory;
}

const { metadata, author, posts, stories = [], Content } = Astro.props;

const hasContent = typeof Content === 'function';
const hasPosts = Array.isArray(posts) && posts.length > 0;
const hasStories = Array.isArray(stories) && stories.length > 0;

const avatar = author?.avatar;
const avatarSrc = typeof avatar === 'object' && avatar ? (avatar as ImageMetadata).src : avatar;
const avatarAlt = author?.name ? `Ảnh chân dung của ${author.name}` : 'Ảnh tác giả';

const badgeLink = `/authors/badge/${cleanSlug(author?.username)}`;
---

<Layout metadata={metadata}>
  <section class="px-4 py-16 sm:px-6 mx-auto lg:px-8 max-w-4xl">
    <div class="flex flex-col items-center text-center gap-6">
      {
        avatarSrc && (
          <a href={badgeLink} class="group relative" aria-label={`Xem badge 3D của ${author.name}`}>
            <img
              src={avatarSrc}
              alt={avatarAlt}
              width="160"
              height="160"
              loading="lazy"
              class="h-32 w-32 rounded-full object-cover shadow-lg ring-4 ring-[#367980]/30 transition-transform duration-200 group-hover:scale-[1.03]"
            />
            <span class="sr-only">Mở huy hiệu 3D</span>
          </a>
        )
      }
      <div class="space-y-3">
        <h1 class="font-heading text-3xl md:text-4xl font-semibold text-slate-900 dark:text-slate-100">
          {author.name}
        </h1>
        {author.bio && <p class="text-lg text-slate-600 dark:text-slate-300">{author.bio}</p>}
        {
          author.website && (
            <p>
              <a
                href={author.website}
                class="inline-flex items-center gap-2 text-[#367980] hover:text-[#27575c] font-medium"
                rel="noopener noreferrer"
                target="_blank">
                <span>Website cá nhân</span>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-4 w-4">
                  <path d="M12.5 3.75a.75.75 0 0 0 0 1.5h1.69l-6.22 6.22a.75.75 0 1 0 1.06 1.06l6.22-6.22v1.69a.75.75 0 0 0 1.5 0v-4a.75.75 0 0 0-.75-.75h-4z" />
                  <path d="M5.5 5.5a2.5 2.5 0 0 0-2.5 2.5v6a2.5 2.5 0 0 0 2.5 2.5h6a2.5 2.5 0 0 0 2.5-2.5v-1.75a.75.75 0 0 0-1.5 0V14a1 1 0 0 1-1 1h-6a1 1 0 0 1-1-1V8a1 1 0 0 1 1-1h1.75a.75.75 0 0 0 0-1.5H5.5z" />
                </svg>
              </a>
            </p>
          )
        }
      </div>
    </div>
  </section>

  {/* Stories Section */}
  {
    hasStories && (
      <section class="px-4 sm:px-6 lg:px-8 mx-auto max-w-5xl pb-12">
        <div class="flex items-center justify-between flex-wrap gap-4 mb-6">
          <h2 class="text-2xl font-semibold text-slate-900 dark:text-slate-100">Bản tin</h2>
          <span class="text-sm text-slate-500 dark:text-slate-400">{stories.length} bản tin</span>
        </div>
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
          {stories.map((story) => {
            const thumbnail = story.data.thumbnail;
            const thumbnailSrc =
              typeof thumbnail === 'object' && thumbnail ? (thumbnail as ImageMetadata).src : thumbnail;
            return (
              <a
                href={`/stories/${story.data.id}`}
                class="group relative aspect-[9/16] rounded-xl overflow-hidden bg-slate-800 shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-[1.02]">
                {thumbnailSrc ? (
                  <img src={thumbnailSrc} alt={story.data.title} class="absolute inset-0 w-full h-full object-cover" />
                ) : (
                  <div class="absolute inset-0 bg-gradient-to-br from-purple-600 to-pink-500" />
                )}
                <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent" />
                <div class="absolute bottom-0 left-0 right-0 p-3">
                  <h3 class="text-white font-medium text-sm line-clamp-2">{story.data.title}</h3>
                  <p class="text-white/70 text-xs mt-1">{story.data.slides?.length || 0} slides</p>
                </div>
                <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity bg-black/30">
                  <div class="w-12 h-12 rounded-full bg-white/20 backdrop-blur-sm flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" class="w-6 h-6">
                      <path d="M8 5v14l11-7z" />
                    </svg>
                  </div>
                </div>
              </a>
            );
          })}
        </div>
      </section>
    )
  }
  {
    hasContent && (
      <section class="px-4 sm:px-6 lg:px-8 mx-auto max-w-4xl pb-12">
        <div class="prose prose-lg max-w-none dark:prose-invert prose-headings:text-slate-800 dark:prose-headings:text-slate-100">
          <Content />
        </div>
      </section>
    )
  }

  <section class="px-4 sm:px-6 lg:px-8 mx-auto max-w-5xl pb-20">
    <div class="flex items-center justify-between flex-wrap gap-4 mb-8">
      <h2 class="text-2xl font-semibold text-slate-900 dark:text-slate-100">Bài viết của {author.name}</h2>
      <span class="text-sm text-slate-500 dark:text-slate-400">
        {hasPosts ? `${posts.length} bài viết` : 'Chưa có bài viết nào'}
      </span>
    </div>
    {
      hasPosts ? (
        <BlogList posts={posts} />
      ) : (
        <p class="text-slate-600 dark:text-slate-300">Đang cập nhật nội dung...</p>
      )
    }
  </section>

  <BackToTop threshold={300} />
</Layout>
