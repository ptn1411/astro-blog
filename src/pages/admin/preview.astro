---
import Layout from '~/layouts/AnimationPageLayout.astro';
import ClientPreview from '~/components/admin/builder/ClientPreview';

// We no longer need server-side parsing of blocks since we render on client
const metadata = {
  title: 'Builder Preview',
};
---

<Layout metadata={metadata}>
  <ClientPreview client:only="react" />
</Layout>

<script>
  // Add listener for real-time updates from parent iframe (Builder)
  window.addEventListener('message', (event) => {
    if (event.data.type === 'PREVIEW_UPDATE') {
      const { blocks, metadata } = event.data.payload;
      // Update localStorage so ClientPreview picks it up via storage event (or we can dispatch custom event)
      localStorage.setItem('astro-builder-blocks', JSON.stringify({ blocks, metadata }));

      // Dispatch a storage event manually because setItem in the same window doesn't trigger 'storage' event
      window.dispatchEvent(
        new StorageEvent('storage', {
          key: 'astro-builder-blocks',
          newValue: JSON.stringify({ blocks, metadata }),
        })
      );
    }
  });
</script>
